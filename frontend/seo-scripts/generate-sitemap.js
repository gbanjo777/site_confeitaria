import fs from "fs";
import path from "path";

const baseUrl = "https://gbanjo777.github.io/site-confeitaria";
const distDir = "./dist";
const outFile = "./dist/sitemap.xml";
const contentDir = "./seo/content";

function collectHtmlFiles(dir, basePath = "") {
  const results = [];

  if (!fs.existsSync(dir)) {
    return results;
  }

  const list = fs.readdirSync(dir);

  list.forEach((file) => {
    const full = path.join(dir, file);
    const stat = fs.statSync(full);

    if (stat && stat.isDirectory()) {
      const subPath = path.join(basePath, file);
      results.push(...collectHtmlFiles(full, subPath));
    } else if (file.endsWith(".html")) {
      const relativePath = path.join(basePath, file).replace(/\\/g, "/");
      let url = `${baseUrl}${relativePath.startsWith("/") ? "" : "/"}${relativePath}`;

      // Se for index.html, remova o nome do arquivo e mantenha o caminho do diretório (terminando com /)
      if (file === "index.html") {
        url = url.replace(/\/index\.html$/, "/");
      }

      let lastmod = stat.mtime.toISOString();

      // Use o mtime do arquivo markdown para postagens de blog (o HTML é regenerado a cada compilação)
      if (basePath.includes("/blog") && file === "index.html") {
        const pathParts = relativePath.split("/");
        const slug = pathParts[pathParts.length - 2];

        if (slug && slug !== "blog") {
          const mdPath = path.join(contentDir, `${slug}.md`);
          if (fs.existsSync(mdPath)) {
            const mdStat = fs.statSync(mdPath);
            lastmod = mdStat.mtime.toISOString();
          }
        }
      }

      results.push({ url, lastmod });
    }
  });

  return results;
}

// coleta URLs
const urls = [];

if (fs.existsSync(path.join(distDir, "index.html"))) {
  const stat = fs.statSync(path.join(distDir, "index.html"));
  urls.push({
    url: baseUrl,
    lastmod: stat.mtime.toISOString(),
  });
}

// coleta arquivos HTML na raiz de dist de blog
const blogDir = path.join(distDir, "blog");
if (fs.existsSync(blogDir)) {
  const blogUrls = collectHtmlFiles(blogDir, "/blog");
  urls.push(...blogUrls);
}

// Colete arquivos HTML em outros diretórios (se houver)
const seoDir = path.join(distDir, "seo");
if (fs.existsSync(seoDir)) {
  const seoUrls = collectHtmlFiles(seoDir, "/seo");
  urls.push(...seoUrls);
}

// Genera sitemap.xml
let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
xml += `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n`;

urls.forEach((item) => {
  xml += `  <url>\n`;
  xml += `    <loc>${item.url}</loc>\n`;
  xml += `    <lastmod>${item.lastmod}</lastmod>\n`;
  xml += `  </url>\n`;
});

xml += `</urlset>`;

fs.writeFileSync(outFile, xml, "utf-8");

console.log(`✓ sitemap.xml generated (${urls.length} URL(s))`);
